[gcode_macro KDUST]
description: Klipper Dusting Utility with Sweeping Technique
description: moves toolhead from min to max in zig zag using fan to clear dust and debris
gcode:
    {% if 'xyz' in printer.toolhead.homed_axes %}     
        {% set y_distance = 10 %}  # Set the distance to move on the Y-axis in mm
        {% set z_height = 5 %}     # Set height in mm
        {% set speed = 50 %}       # Set the speed of movement in mm/s
        {% set repeats = 0 %}

        {% set ns = namespace() %}
        {% set ns.position = [printer.toolhead.axis_minimum.x, printer.toolhead.axis_minimum.y] %}
        {% set coordinates = [] %}       
        
        {% for repeat in range(1 + repeats) %}
            {% for i in range(((printer.toolhead.axis_maximum.y / y_distance) / 2 )|int) %}
                {% set ns.position = [printer.toolhead.axis_maximum.x, ns.position[1]] %}
                {% set _ = coordinates.append(ns.position) %}
                
                {% set next_y = ns.position[1] + y_distance + i %}
                {% if next_y <= printer.toolhead.axis_maximum.y %}
                    {% set ns.position = [ns.position[0], next_y] %}
                    {% set _ = coordinates.append(ns.position) %}
                {% else %}
                    {% set ns.position = [ns.position[0], printer.toolhead.axis_maximum.y] %}
                    {% set _ = coordinates.append(ns.position) %}
                    {% set ns.position = [printer.toolhead.axis_minimum.x, ns.position[1]] %}
                    {% set _ = coordinates.append(ns.position) %}
                {% endif %}
                
                {% set ns.position = [printer.toolhead.axis_minimum.x, ns.position[1]] %}
                {% set _ = coordinates.append(ns.position) %}
                
                {% set next_y = ns.position[1] + y_distance + i %}
                {% if next_y <= printer.toolhead.axis_maximum.y %}
                    {% set ns.position = [ns.position[0], next_y] %}
                    {% set _ = coordinates.append(ns.position) %}
                {% else %}
                    {% set ns.position = [ns.position[0], printer.toolhead.axis_maximum.y] %}
                    {% set _ = coordinates.append(ns.position) %}
                    {% set ns.position = [printer.toolhead.axis_maximum.x, ns.position[1]] %}
                    {% set _ = coordinates.append(ns.position) %}
                {% endif %}
            {% endfor %}
        {% endfor %}

        G0 X{printer.toolhead.axis_minimum.x} Y{printer.toolhead.axis_minimum.y} F{speed * 60}  # Move the toolhead to the minimum X and Y positions
        G0 Z{z_height}
        M106 S255  # Crank fan speed to max
    
        {% for coordinate in coordinates[1:] %}
            G0 X{coordinate[0]} Y{coordinate[1]} F{speed * 60}
        {% endfor %}
    
        M107  # Turn off the fan
    
    {% else %}
        { action_respond_info("Printer must be homed first") }
    {% endif %}
